const { Telegraf } = require('telegraf');

const bot = new Telegraf('8017281955:AAHUWgqvjsb_sT7tGTZgcSL9Mte8Wt_GhDk'); // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
const userStates = {};

const STATES = {
  START: 'start',
  ASK_CITY: 'ask_city',
  WAITING_VOICE: 'waiting_voice',
  ASK_CONTACT: 'ask_contact',
 FINISHED: 'finished'
};

bot.start((ctx) => {
  userStates[ctx.from.id] = { state: STATES.START };
  ctx.replyWithMarkdownV2(
    `–ü—Ä–∏–≤–µ—Ç\\! –≠—Ç–æ –±–æ—Ç –ø—Ä–æ–µ–∫—Ç–∞ *Voices*\\.\n\n` +
    `–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî —Ç—ë–ø–ª—ã–µ, —É—è–∑–≤–∏–º—ã–µ, –Ω–∞—Å—Ç–æ—è—â–∏–µ\\. –ü—Ä–æ —Ç–æ, –∫–∞–∫ –º–µ–Ω—è–ª–∏—Å—å –≤—ã –∏ –º–∏—Ä –≤–æ–∫—Ä—É–≥ —Å 2022 –≥–æ–¥–∞\\.\n\n` +
    `–ì–æ–≤–æ—Ä–∏—Ç—å ‚Äî –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ\\. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî —á–µ—Å—Ç–Ω–æ\\.\n\n` +
    `–ì–æ—Ç–æ–≤—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≥–æ–ª–æ—Å–æ–º? üéôÔ∏è`,
    {
      reply_markup: {
        keyboard: [['–•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å'], ['–•–æ—á—É —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ']],
        resize_keyboard: true,
        one_time_keyboard: true,
      }
    }
  );
});

bot.hears('–•–æ—á—É —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ', (ctx) => {
  ctx.replyWithMarkdownV2(
    `–ü—Ä–æ–µ–∫—Ç *Voices* ‚Äî —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –≤–µ–±\\-–∑–∏–Ω –∏ –∫–∞—Ä—Ç–∞ –≥–æ–ª–æ—Å–æ–≤\\.\n\n` +
    `–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏–∏ –ª—é–¥–µ–π –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –∏ —Å—Ç—Ä–∞–Ω:\n` +
    `‚Äî –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–¥—ã?\n` +
    `‚Äî –ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ?\n` +
    `‚Äî –ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º –¥–µ—Ä–∂–∞—Ç—å—Å—è?\n\n` +
    `–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∞–Ω–æ–Ω–∏–º–Ω—ã–º\\.\n` +
    `–ú—ã –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ç–∏–º —É—Å–ª—ã—à–∞—Ç—å ‚Äî –∏ –ø–æ–∫–∞–∑–∞—Ç—å, –∫–∞–∫ –∑–≤—É—á–∏—Ç –º–∏—Ä\\.\n\n` +
    `–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?`,
    {
      reply_markup: {
        keyboard: [['–î–∞, –¥–∞–≤–∞–π—Ç–µ']],
        resize_keyboard: true,
        one_time_keyboard: true,
      }
    }
  );
});

bot.hears(['–•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å', '–î–∞, –¥–∞–≤–∞–π—Ç–µ'], (ctx) => {
  userStates[ctx.from.id] = { state: STATES.ASK_CITY };
  ctx.reply('–°–Ω–∞—á–∞–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∏–∑ –∫–∞–∫–æ–≥–æ –≤—ã –≥–æ—Ä–æ–¥–∞.\n\n–ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥ –∏ —Å—Ç—Ä–∞–Ω—É.\n–ù–∞–ø—Ä–∏–º–µ—Ä:\n> –ë–µ—Ä–ª–∏–Ω, –ì–µ—Ä–º–∞–Ω–∏—è\n> –ï—Ä–µ–≤–∞–Ω, –ê—Ä–º–µ–Ω–∏—è');
});

bot.on('text', (ctx) => {
  const userId = ctx.from.id;
  const userState = userStates[userId];

  if (!userState) return;

  if (userState.state === STATES.ASK_CITY) {
    userStates[userId].city = ctx.message.text;
    userStates[userId].state = STATES.WAITING_VOICE;
    ctx.reply(
      `–°–ø–∞—Å–∏–±–æ. –¢–µ–ø–µ—Ä—å ‚Äî –≤–∞—à –≥–æ–ª–æ—Å.\n\n` +
      `–ú–æ–∂–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –≤—Å—ë, —á—Ç–æ —Ö–æ—á–µ—Ç—Å—è. –í–æ—Ç –ø—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:\n\n` +
      `‚Ä¢ –ì–¥–µ –≤—ã –±—ã–ª–∏, –∫–æ–≥–¥–∞ –≤—Å—ë –Ω–∞—á–∞–ª–æ—Å—å?\n` +
      `‚Ä¢ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏ –∑–∞ 3 –≥–æ–¥–∞?\n` +
      `‚Ä¢ –ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º –¥–µ—Ä–∂–∞—Ç—å—Å—è?\n` +
      `‚Ä¢ –ß—Ç–æ –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã —Å–∫–∞–∑–∞—Ç—å –∫–æ–º—É-—Ç–æ, –∫—Ç–æ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –ø–æ—Ö–æ–∂–µ–µ?\n\n` +
      `–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—å, –∫–∞–∫ –∏–¥—ë—Ç.\n\n` +
      `–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã ‚Äî –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä—è–º–æ –∑–¥–µ—Å—å.`
    );
  } else if (userState.state === STATES.ASK_CONTACT) {
    userStates[userId].contact = ctx.message.text;
    userStates[userId].state = STATES.FINISHED;
    ctx.reply('–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å.\n–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ ‚Äî –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∏ –∑–∞–ø–∏—Å–∞—Ç—å –µ—â—ë.', {
      reply_markup: {
        keyboard: [['–ó–∞–ø–∏—Å–∞—Ç—å –µ—â—ë –æ–¥–Ω–æ'], ['–ó–∞–≤–µ—Ä—à–∏—Ç—å']],
        resize_keyboard: true,
      }
    });
  }
});

const ADMIN_ID = 1006525845;

bot.on('voice', async (ctx) => {
  const userId = ctx.from.id;
  const userState = userStates[userId];

  if (userState?.state === STATES.WAITING_VOICE) {
    userStates[userId].state = STATES.ASK_CONTACT;

    // –ü–µ—Ä–µ—à–ª—ë–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    await ctx.telegram.sendVoice(ADMIN_ID, ctx.message.voice.file_id, {
      caption: `üì• –ù–æ–≤—ã–π –≥–æ–ª–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from.first_name} (${ctx.from.username || '–±–µ–∑ username'})\nüåç –ì–æ—Ä–æ–¥: ${userState.city || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`,
    });

    ctx.reply(
      '–°–ø–∞—Å–∏–±–æ. –í–∞—à –≥–æ–ª–æ—Å ‚Äî —á–∞—Å—Ç—å –∂–∏–≤–æ–π –∫–∞—Ä—Ç—ã.\n–ú—ã –±–µ—Ä–µ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –∏ —Ä–∞–∑–º–µ—Å—Ç–∏–º –µ–≥–æ –∞–Ω–æ–Ω–∏–º–Ω–æ.\n\n–•–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç, —á—Ç–æ–±—ã –º—ã –ø—Ä–∏—Å–ª–∞–ª–∏ –≤–∞–º —Å—Å—ã–ª–∫—É, –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ?',
      {
        reply_markup: {
          keyboard: [['–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç'], ['–ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ']],
          resize_keyboard: true,
          one_time_keyboard: true,
        }
      }
    );
  }
});


bot.hears('–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç', (ctx) => {
  userStates[ctx.from.id].state = STATES.ASK_CONTACT;
  ctx.reply('–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email –∏–ª–∏ Telegram-–Ω–∏–∫–Ω–µ–π–º.\n–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞—à —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∫–∞—Ä—Ç—ã.');
});

bot.hears('–ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ', (ctx) => {
  userStates[ctx.from.id].state = STATES.FINISHED;
  ctx.reply('–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å.\n–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ ‚Äî –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∏ –∑–∞–ø–∏—Å–∞—Ç—å –µ—â—ë.', {
    reply_markup: {
      keyboard: [['–ó–∞–ø–∏—Å–∞—Ç—å –µ—â—ë –æ–¥–Ω–æ'], ['–ó–∞–≤–µ—Ä—à–∏—Ç—å']],
      resize_keyboard: true,
    }
  });
});

bot.hears('–ó–∞–ø–∏—Å–∞—Ç—å –µ—â—ë –æ–¥–Ω–æ', (ctx) => {
  userStates[ctx.from.id] = { state: STATES.ASK_CITY };
  ctx.reply('–°–Ω–∞—á–∞–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∏–∑ –∫–∞–∫–æ–≥–æ –≤—ã –≥–æ—Ä–æ–¥–∞.');
});

bot.hears('–ó–∞–≤–µ—Ä—à–∏—Ç—å', (ctx) => {
  delete userStates[ctx.from.id];
  ctx.reply('–î–æ –≤—Å—Ç—Ä–µ—á–∏. –ú—ã —Ä—è–¥–æ–º üåø', {
    reply_markup: { remove_keyboard: true }
  });
});

bot.launch();
console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω');
