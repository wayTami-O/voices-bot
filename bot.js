const { Telegraf, Markup } = require('telegraf');

const bot = new Telegraf('8017281955:AAHUWgqvjsb_sT7tGTZgcSL9Mte8Wt_GhDk')

const ADMIN_ID = 1006525845;

const userState = {}

bot.start((ctx) => {
  userState[ctx.from.id] = { step: 'start' }
  ctx.reply(
    `ะัะธะฒะตั! ะญัะพ ะฑะพั ะฟัะพะตะบัะฐ *Voices*.\n\n` +
    `ะั ัะพะฑะธัะฐะตะผ ะณะพะปะพัะพะฒัะต ะธััะพัะธะธ ะฟัะพ ัะพ, ะบะฐะบ ะผะตะฝัะตะผัั ะผั ะธ ะผะธั ะฒะพะบััะณ ั 2022 ะณะพะดะฐ.\n\n` +
    `ะัะฐะฒะธะปัะฝัั ะพัะฒะตัะพะฒ ะฝะตั. ะะพััะฐัะพัะฝะพ ะณะพะฒะพัะธัั ะธัะบัะตะฝะฝะต.\n\n` +
    `ะะพัะพะฒั ะฟะพะดะตะปะธัััั ัะฒะพะตะน ะธััะพัะธะตะน? ๐๏ธ`,
    Markup.keyboard([
      ['ะฅะพัั ัะฐััะบะฐะทะฐัั'],
      ['ะฅะพัั ัะทะฝะฐัั ะฑะพะปััะต']
    ]).resize()
  )
})

// ะฅะพัั ัะทะฝะฐัั ะฑะพะปััะต
bot.hears('ะฅะพัั ัะทะฝะฐัั ะฑะพะปััะต', (ctx) => {
  ctx.reply(
    `โน๏ธ *Voices* โ ััะพ ะดะพะบัะผะตะฝัะฐะปัะฝัะน ะฒะตะฑ-ะทะธะฝ.\n` +
    `ะั ัะพะฑะธัะฐะตะผ ะฐะฝะพะฝะธะผะฝัะต ะณะพะปะพัะพะฒัะต ัะพะพะฑัะตะฝะธั ะพั ััััะบะพัะทััะฝัั ะปัะดะตะน ะธะท ัะฐะทะฝัั ัััะฐะฝ, ััะพะฑั ััะปััะฐัั, ะบะฐะบ ะทะฒััะธั ััะพั ะผะธั ะฒ ะผะพะผะตะฝั ะฟะตัะตะผะตะฝ.\n\n` +
    `ะะพัะพะฒั ะฝะฐัะฐัั?`,
    Markup.keyboard([['ะะฐ, ะดะฐะฒะฐะนัะต']]).resize()
  );
});

// ะะฐัะฐัั
bot.hears(['ะฅะพัั ัะฐััะบะฐะทะฐัั', 'ะะฐ, ะดะฐะฒะฐะนัะต'], (ctx) => {
  userState[ctx.from.id] = { step: 'await_location' };
  ctx.reply(
    `๐๏ธ ะจะะ 1 โ ะฃัะพัะฝะตะฝะธะต ะณะพัะพะดะฐ ะธ ะธะผะตะฝะธ\n\n` +
    `ะกะฝะฐัะฐะปะฐ, ะฟะพะถะฐะปัะนััะฐ, ะฝะฐะฟะธัะธัะต, ะพัะบัะดะฐ ะฒั, ะธ ะบะฐะบ ะฒะฐั ะทะพะฒัั. ะะผั ะผะพะถะตั ะฑััั ะฒัะผััะปะตะฝะฝัะผ.\n\nะะฐะฟัะธะผะตั:\n` +
    `> ะััะตะผ, ะะตัะปะธะฝ, ะะตัะผะฐะฝะธั`
  );
});

// ะะพะปััะฐะตะผ ะปะพะบะฐัะธั ะธ ะธะผั
bot.on('text', (ctx) => {
  const state = userState[ctx.from.id];

  if (!state) return;

  if (state.step === 'await_location') {
    state.location = ctx.message.text;
    state.step = 'await_voice';
    ctx.reply(
      `๐๏ธ ะจะะ 2 โ ะะฐะฟะธัั ะณะพะปะพัะพะฒะพะณะพ\n\n` +
      `ะกะฟะฐัะธะฑะพ. ะขะตะฟะตัั โ ะฒะฐั ะณะพะปะพั.\n\n` +
      `ะะพะถะฝะพ ัะฐััะบะฐะทะฐัั ะฒัั, ััะพ ัะพัะตััั. ะะพั ะฟัะธะผะตัั ะฒะพะฟัะพัะพะฒ:\n\n` +
      `โข ะะดะต ะฒั ะฑัะปะธ, ะบะพะณะดะฐ ะฒัั ะฝะฐัะฐะปะพัั?\n` +
      `โข ะงัะพ ะธะทะผะตะฝะธะปะพัั ะฒ ะฒะฐัะตะน ะถะธะทะฝะธ ะทะฐ 3 ะณะพะดะฐ?\n` +
      `โข ะะฐะบะธะต ััะฒััะฒะฐ ะฒั ะธัะฟัััะฒะฐะปะธ?\n` +
      `โข ะงัะพ ะฟะพะผะพะณะฐะตั ะฒะฐะผ ะดะตัะถะฐัััั?\n\n` +
      `ะะพะณะดะฐ ะฑัะดะตัะต ะณะพัะพะฒั โ ะทะฐะฟะธัะธัะต ะณะพะปะพัะพะฒะพะต ัะพะพะฑัะตะฝะธะต ะฟััะผะพ ะทะดะตัั.`
    );
  } else if (state.step === 'await_contact') {
    state.contact = ctx.message.text;
    state.step = 'done';
    ctx.reply(
      `ะกะฟะฐัะธะฑะพ! ะั ะพัะฟัะฐะฒะธะผ ะฒะฐะผ ัััะปะบั, ะบะพะณะดะฐ ะทะฐะฟะธัั ะฟะพัะฒะธััั ะฝะฐ ัะฐะนัะต.`,
      Markup.keyboard([['ะะฐะฟะธัะฐัั ะตัั ะพะดะฝะพ'], ['ะะฐะฒะตััะธัั']]).resize()
    );

    // ะัะฟัะฐะฒะปัะตะผ ะฐะดะผะธะฝะธัััะฐัะพัั ะดะฐะฝะฝัะต
    sendToAdmin(ctx.from.id);
  }
});

// ะะพะปััะฐะตะผ ะณะพะปะพัะพะฒะพะต
bot.on('voice', async (ctx) => {
  const state = userState[ctx.from.id];
  if (!state || state.step !== 'await_voice') return;

  state.voice = ctx.message.voice.file_id;
  state.step = 'after_voice';

  ctx.reply(
    `โ ะกะฟะฐัะธะฑะพ. ะะฐั ะณะพะปะพั โ ัะฐััั ะถะธะฒะพะน ะบะฐััั.\n\n` +
    `ะฅะพัะธัะต ะพััะฐะฒะธัั ะบะพะฝัะฐะบั, ััะพะฑั ะผั ะฟัะธัะปะฐะปะธ ะฒะฐะผ ัััะปะบั, ะบะพะณะดะฐ ะทะฐะฟะธัั ะฟะพัะฒะธััั ะฝะฐ ัะฐะนัะต? ะญัะพ ะฝะต ะพะฑัะทะฐัะตะปัะฝะพ.`,
    Markup.keyboard([['ะััะฐะฒะธัั ะบะพะฝัะฐะบั'], ['ะะตั, ัะฟะฐัะธะฑะพ']]).resize()
  );
});

// ะะพะฝัะฐะบั
bot.hears('ะััะฐะฒะธัั ะบะพะฝัะฐะบั', (ctx) => {
  const state = userState[ctx.from.id];
  if (state) {
    state.step = 'await_contact';
    ctx.reply(`โ๏ธ ะั ะผะพะถะตัะต ะพัะฟัะฐะฒะธัั email ะธะปะธ Telegram-ะฝะธะบะฝะตะนะผ.`);
  }
});

// ะะตะท ะบะพะฝัะฐะบัะฐ
bot.hears('ะะตั, ัะฟะฐัะธะฑะพ', (ctx) => {
  const state = userState[ctx.from.id];
  if (state) {
    state.step = 'done';
    ctx.reply(
      `ะกะฟะฐัะธะฑะพ, ััะพ ะฟะพะดะตะปะธะปะธัั. ะัะปะธ ะทะฐัะพัะธัะต โ ะฒั ะฒัะตะณะดะฐ ะผะพะถะตัะต ะฒะตัะฝััััั ะธ ะทะฐะฟะธัะฐัั ะตัั.`,
      Markup.keyboard([['ะะฐะฟะธัะฐัั ะตัั ะพะดะฝะพ'], ['ะะฐะฒะตััะธัั']]).resize()
    );

    // ะัะฟัะฐะฒะปัะตะผ ะฐะดะผะธะฝะธัััะฐัะพัั ะดะฐะฝะฝัะต
    sendToAdmin(ctx.from.id);
  }
});

// ะะพะฒัะพั
bot.hears('ะะฐะฟะธัะฐัั ะตัั ะพะดะฝะพ', (ctx) => {
  userState[ctx.from.id] = { step: 'await_location' };
  ctx.reply(
    `๐๏ธ ะกะฝะพะฒะฐ ะฝะฐะฟะธัะธัะต, ะพัะบัะดะฐ ะฒั, ะธ ะบะฐะบ ะฒะฐั ะทะพะฒัั.\n\nะะฐะฟัะธะผะตั:\n> ะะฝะฝะฐ, ะะฐัะธะถ, ะคัะฐะฝัะธั`
  );
});

// ะะฐะฒะตััะตะฝะธะต
bot.hears('ะะฐะฒะตััะธัั', (ctx) => {
  delete userState[ctx.from.id];
  ctx.reply(`ะะพ ะฒัััะตัะธ. ะั ััะดะพะผ.`);
});

// ะัะฟัะฐะฒะบะฐ ะดะฐะฝะฝัั ะฐะดะผะธะฝั
async function sendToAdmin(userId) {
  const data = userState[userId];
  if (!data) return;

  let message = `๐ฌ ะะพะฒะพะต ัะพะพะฑัะตะฝะธะต ะพั ะฟะพะปัะทะพะฒะฐัะตะปั:\n\n`;
  message += `๐ ะะพะบะฐัะธั: ${data.location || 'โ'}\n`;
  message += `๐ฑ ะะพะฝัะฐะบั: ${data.contact || 'โ'}\n`;

  await bot.telegram.sendMessage(ADMIN_ID, message);

  if (data.voice) {
    await bot.telegram.sendVoice(ADMIN_ID, data.voice, {
      caption: '๐ ะะพะปะพัะพะฒะพะต ัะพะพะฑัะตะฝะธะต',
    });
  }
}

bot.launch();
console.log('๐ค ะะพั ะทะฐะฟััะตะฝ');

const http = require('http');
const PORT = process.env.PORT || 3000;

http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('๐ค Bot is running!\n');
}).listen(PORT, () => {
  console.log(`๐ HTTP-ัะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั ${PORT}`);
});
