const { Telegraf, Markup } = require('telegraf');

const bot = new Telegraf('8017281955:AAHUWgqvjsb_sT7tGTZgcSL9Mte8Wt_GhDk')

const ADMIN_ID = 1006525845;

const userState = {}

bot.start((ctx) => {
  userState[ctx.from.id] = { step: 'start' }
  ctx.reply(
    `–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –±–æ—Ç –ø—Ä–æ–µ–∫—Ç–∞ *Voices*.\n\n` +
    `–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ —Ç–æ, –∫–∞–∫ –º–µ–Ω—è–µ–º—Å—è –º—ã –∏ –º–∏—Ä –≤–æ–∫—Ä—É–≥ —Å 2022 –≥–æ–¥–∞.\n\n` +
    `–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–µ—Ç. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å –∏—Å–∫—Ä–µ–Ω–Ω–µ.\n\n` +
    `–ì–æ—Ç–æ–≤—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π? üéôÔ∏è`,
    Markup.keyboard([
      ['–•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å'],
      ['–•–æ—á—É —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ']
    ]).resize()
  )
})

// –•–æ—á—É —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ
bot.hears('–•–æ—á—É —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ', (ctx) => {
  ctx.reply(
    `‚ÑπÔ∏è *Voices* ‚Äî —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –≤–µ–±-–∑–∏–Ω.\n` +
    `–ú—ã —Å–æ–±–∏—Ä–∞–µ–º –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ª—é–¥–µ–π –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω, —á—Ç–æ–±—ã —É—Å–ª—ã—à–∞—Ç—å, –∫–∞–∫ –∑–≤—É—á–∏—Ç —ç—Ç–æ—Ç –º–∏—Ä –≤ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–µ–º–µ–Ω.\n\n` +
    `–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?`,
    Markup.keyboard([['–î–∞, –¥–∞–≤–∞–π—Ç–µ']]).resize()
  );
});

// –ù–∞—á–∞—Ç—å
bot.hears(['–•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å', '–î–∞, –¥–∞–≤–∞–π—Ç–µ'], (ctx) => {
  userState[ctx.from.id] = { step: 'await_location' };
  ctx.reply(
    `üèôÔ∏è –®–ê–ì 1 ‚Äî –£—Ç–æ—á–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏ –∏–º–µ–Ω–∏\n\n` +
    `–°–Ω–∞—á–∞–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –æ—Ç–∫—É–¥–∞ –≤—ã, –∏ –∫–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç. –ò–º—è –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–º—ã—à–ª–µ–Ω–Ω—ã–º.\n\n–ù–∞–ø—Ä–∏–º–µ—Ä:\n` +
    `> –ê—Ä—Ç–µ–º, –ë–µ—Ä–ª–∏–Ω, –ì–µ—Ä–º–∞–Ω–∏—è`
  );
});

// –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞—Ü–∏—é –∏ –∏–º—è
bot.on('text', (ctx) => {
  const state = userState[ctx.from.id];

  if (!state) return;

  if (state.step === 'await_location') {
    state.location = ctx.message.text;
    state.step = 'await_voice';
    ctx.reply(
      `üéôÔ∏è –®–ê–ì 2 ‚Äî –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ\n\n` +
      `–°–ø–∞—Å–∏–±–æ. –¢–µ–ø–µ—Ä—å ‚Äî –≤–∞—à –≥–æ–ª–æ—Å.\n\n` +
      `–ú–æ–∂–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –≤—Å—ë, —á—Ç–æ —Ö–æ—á–µ—Ç—Å—è. –í–æ—Ç –ø—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:\n\n` +
      `‚Ä¢ –ì–¥–µ –≤—ã –±—ã–ª–∏, –∫–æ–≥–¥–∞ –≤—Å—ë –Ω–∞—á–∞–ª–æ—Å—å?\n` +
      `‚Ä¢ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏ –∑–∞ 3 –≥–æ–¥–∞?\n` +
      `‚Ä¢ –ö–∞–∫–∏–µ —á—É–≤—Å—Ç–≤–∞ –≤—ã –∏—Å–ø—ã—Ç—ã–≤–∞–ª–∏?\n` +
      `‚Ä¢ –ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º –¥–µ—Ä–∂–∞—Ç—å—Å—è?\n\n` +
      `–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã ‚Äî –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä—è–º–æ –∑–¥–µ—Å—å.`
    );
  } else if (state.step === 'await_contact') {
    state.contact = ctx.message.text;
    state.step = 'done';
    ctx.reply(
      `–°–ø–∞—Å–∏–±–æ! –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞–º —Å—Å—ã–ª–∫—É, –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ.`,
      Markup.keyboard([['–ó–∞–ø–∏—Å–∞—Ç—å –µ—â—ë –æ–¥–Ω–æ'], ['–ó–∞–≤–µ—Ä—à–∏—Ç—å']]).resize()
    );

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–∞–Ω–Ω—ã–µ
    sendToAdmin(ctx.from.id);
  }
});

// –ü–æ–ª—É—á–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ
bot.on('voice', async (ctx) => {
  const state = userState[ctx.from.id];
  if (!state || state.step !== 'await_voice') return;

  state.voice = ctx.message.voice.file_id;
  state.step = 'after_voice';

  ctx.reply(
    `‚úÖ –°–ø–∞—Å–∏–±–æ. –í–∞—à –≥–æ–ª–æ—Å ‚Äî —á–∞—Å—Ç—å –∂–∏–≤–æ–π –∫–∞—Ä—Ç—ã.\n\n` +
    `–•–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç, —á—Ç–æ–±—ã –º—ã –ø—Ä–∏—Å–ª–∞–ª–∏ –≤–∞–º —Å—Å—ã–ª–∫—É, –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ? –≠—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.`,
    Markup.keyboard([['–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç'], ['–ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ']]).resize()
  );
});

// –ö–æ–Ω—Ç–∞–∫—Ç
bot.hears('–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç', (ctx) => {
  const state = userState[ctx.from.id];
  if (state) {
    state.step = 'await_contact';
    ctx.reply(`‚úâÔ∏è –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email –∏–ª–∏ Telegram-–Ω–∏–∫–Ω–µ–π–º.`);
  }
});

// –ë–µ–∑ –∫–æ–Ω—Ç–∞–∫—Ç–∞
bot.hears('–ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ', (ctx) => {
  const state = userState[ctx.from.id];
  if (state) {
    state.step = 'done';
    ctx.reply(
      `–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å. –ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ ‚Äî –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∏ –∑–∞–ø–∏—Å–∞—Ç—å –µ—â—ë.`,
      Markup.keyboard([['–ó–∞–ø–∏—Å–∞—Ç—å –µ—â—ë –æ–¥–Ω–æ'], ['–ó–∞–≤–µ—Ä—à–∏—Ç—å']]).resize()
    );

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–∞–Ω–Ω—ã–µ
    sendToAdmin(ctx.from.id);
  }
});

// –ü–æ–≤—Ç–æ—Ä
bot.hears('–ó–∞–ø–∏—Å–∞—Ç—å –µ—â—ë –æ–¥–Ω–æ', (ctx) => {
  userState[ctx.from.id] = { step: 'await_location' };
  ctx.reply(
    `üèôÔ∏è –°–Ω–æ–≤–∞ –Ω–∞–ø–∏—à–∏—Ç–µ, –æ—Ç–∫—É–¥–∞ –≤—ã, –∏ –∫–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç.\n\n–ù–∞–ø—Ä–∏–º–µ—Ä:\n> –ê–Ω–Ω–∞, –ü–∞—Ä–∏–∂, –§—Ä–∞–Ω—Ü–∏—è`
  );
});

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
bot.hears('–ó–∞–≤–µ—Ä—à–∏—Ç—å', (ctx) => {
  delete userState[ctx.from.id];
  ctx.reply(`–î–æ –≤—Å—Ç—Ä–µ—á–∏. –ú—ã —Ä—è–¥–æ–º.`);
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω—É
async function sendToAdmin(userId) {
  const data = userState[userId];
  if (!data) return;

  let message = `üì¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n`;
  message += `üåç –õ–æ–∫–∞—Ü–∏—è: ${data.location || '‚Äî'}\n`;
  message += `üì± –ö–æ–Ω—Ç–∞–∫—Ç: ${data.contact || '‚Äî'}\n`;

  await bot.telegram.sendMessage(ADMIN_ID, message);

  if (data.voice) {
    await bot.telegram.sendVoice(ADMIN_ID, data.voice, {
      caption: 'üéô –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
    });
  }
}

bot.launch();
console.log('ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω');